DECLARE @output = "/Transformed/AWSQLDB/3_CreateTableOutput.txt";

DROP TABLE IF EXISTS BikeCollisionData;

CREATE TABLE [master].[dbo].[BikeCollisionData] (
            objectid			int,
            shape				string,
            inckey				int,
            coldetkey			int,
            addrtype			string,
            collisiontype		string,
            diagramlink			string,
            distance			decimal?,
            exceptrsncode		string,
            exceptrsndesc		string,
            fatalities			int,
            inattentionind		string,
            incdate				DateTime,
            incdttm				DateTime,
            injuries			int,
            intkey				int?,
            junctiontype		string,
            lightcond			string,
            location			string,
            pedcount			int,
            pedcylcount			int,
            pedrownotgrnt		string,
            personcount			int,
            reportlink			string,
            reportno			string,
            roadcond			string,
            sdot_colcode		int,
            sdot_coldesc		string,
            sdotcolnum			int?,
            segkey				int?,
            seriousinjuries		int,
            severitycode		string,
            severitydesc		string,
            speeding			string,
            st_colcode			int,
            st_coldesc			string,
            status				string,
            underinfl			string,
            vehcount			int,
            weather				string,
            width				int,
            seglanekey			int,
            crosswalkkey		int,
            hitparkedcar		string,
            spdcaseno			string,
            joinKey             string,

            INDEX bcd_idx CLUSTERED (objectid ASC)
                DISTRIBUTED BY HASH (objectid)
);

DROP FUNCTION IF EXISTS BikeCollisionDataTVF;

CREATE FUNCTION BikeCollisionDataTVF()
RETURNS @BikeCollisionData TABLE
(
            objectid			int,
            shape				string,
            inckey				int,
            coldetkey			int,
            addrtype			string,
            collisiontype		string,
            diagramlink			string,
            distance			decimal?,
            exceptrsncode		string,
            exceptrsndesc		string,
            fatalities			int,
            inattentionind		string,
            incdate				DateTime,
            incdttm				DateTime,
            injuries			int,
            intkey				int?,
            junctiontype		string,
            lightcond			string,
            location			string,
            pedcount			int,
            pedcylcount			int,
            pedrownotgrnt		string,
            personcount			int,
            reportlink			string,
            reportno			string,
            roadcond			string,
            sdot_colcode		int,
            sdot_coldesc		string,
            sdotcolnum			int?,
            segkey				int?,
            seriousinjuries		int,
            severitycode		string,
            severitydesc		string,
            speeding			string,
            st_colcode			int,
            st_coldesc			string,
            status				string,
            underinfl			string,
            vehcount			int,
            weather				string,
            width				int,
            seglanekey			int,
            crosswalkkey		int,
            hitparkedcar		string,
            spdcaseno			string,
            joinKey             string
)
AS BEGIN
DECLARE @inBikeCollisionData = "/Transformed/AWSQLDB/BikeCollisionData.txt";
@BikeCollisionData =
    EXTRACT 
            objectid			int,
            shape				string,
            inckey				int,
            coldetkey			int,
            addrtype			string,
            collisiontype		string,
            diagramlink			string,
            distance			decimal?,
            exceptrsncode		string,
            exceptrsndesc		string,
            fatalities			int,
            inattentionind		string,
            incdate				DateTime,
            incdttm				DateTime,
            injuries			int,
            intkey				int?,
            junctiontype		string,
            lightcond			string,
            location			string,
            pedcount			int,
            pedcylcount			int,
            pedrownotgrnt		string,
            personcount			int,
            reportlink			string,
            reportno			string,
            roadcond			string,
            sdot_colcode		int,
            sdot_coldesc		string,
            sdotcolnum			int?,
            segkey				int?,
            seriousinjuries		int,
            severitycode		string,
            severitydesc		string,
            speeding			string,
            st_colcode			int,
            st_coldesc			string,
            status				string,
            underinfl			string,
            vehcount			int,
            weather				string,
            width				int,
            seglanekey			int,
            crosswalkkey		int,
            hitparkedcar		string,
            spdcaseno			string,
            joinKey             string
    FROM @inBikeCollisionData
USING Extractors.Text(delimiter: '|', skipFirstNRows: 1);
RETURN;
END;

INSERT INTO BikeCollisionData SELECT * FROM master.dbo.BikeCollisionDataTVF() AS bcdtvf;